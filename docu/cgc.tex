\documentclass[a4paper,10pt,parskip=full]{scrartcl}

% \usepackage[T1]{fontenc} % Ligaturen, richtige Umlaute im PDF
% \usepackage[utf8]{inputenc}% UTF8-Kodierung f√ºr Umlaute usw

\usepackage{lmodern}

% \usepackage[pdftex]{graphicx}
\usepackage{dcolumn}
\usepackage{bm}
\usepackage{color}

\usepackage{braket}

\usepackage{amsmath,marvosym,amssymb} % Mathesachen
\DeclareMathOperator{\Tr}{Tr}

\usepackage[pdftex,colorlinks=true,linkcolor=blue,citecolor=blue,filecolor=blue]{hyperref}

% \newcommand{\ff}[1]{{\boldsymbol #1}}
\newcommand{\ca}[1]{{\cal #1}}
\newcommand{\bi}{\begin{itemize}}
\newcommand{\ei}{\end{itemize}}
\newcommand{\be}{\begin{equation}}
\newcommand{\ee}{\end{equation}}
\newcommand{\ba}{\begin{eqnarray}}
\newcommand{\ea}{\end{eqnarray}}
% \newcommand{\cc}[1]{{\color{red}#1}}

\newcommand{\cd}[1]{c_{#1}^\dagger}
\newcommand{\cc}[1]{c_{#1}}
\newcommand{\fd}[1]{f_{#1}^\dagger}
\newcommand{\ff}[1]{f_{#1}}

\newcommand{\jd}{J^{\rm dim}_{\rm c}}
\newcommand{\jm}{J^{\rm mag}_{\rm c}}
\newcommand{\jdv}{0.895t}
\newcommand{\jmv}{0.84t}

\newcommand{\ppp}[1]{\noindent{\color{blue}#1.}}

\newcommand{\si}{{\sigma}}

\title{CGC for DMRG}
\author{MP}

\begin{document}
\maketitle
\tableofcontents
\section{Definition and notation for CGC}
Clebsch-Gordon coefficients describe the coupling of irreps of a group.
For $SU(2)$ the irreps are labeled by the spin quantum number $j$, for $U(1)$
the irreps are labeled by an integer $n$ for the amount of particles for example.
The CGC depend on three irreps: the two ordered (first $j_1$ and second $j_2$) irreps to couple and the total irrep $j$.
\begin{equation}
  \label{eq:cgc-def}
  C^{j_1,j_2\rightarrow j}_{{m_1,m_2\rightarrow m}}
\end{equation}
For $U(1)$, this simply requires $n_1+n_2=n$. Hence the CGc for $U(1)$ are symmetric in $n_1$ and $n_2$
but \emph{not} for other permutations.
For $SU(2)$ the symmetry relations can be found on wikipedia.
\section{$6j$, $9j$ and recoupling symbols}
CGC can be multiplied to give recoupling coefficients which are related to
Wigner $3nj$-symbols. The $6j$-symbol is related to the recoupling of three irreps:
\begin{equation}
  \label{eq:recoupling-three}
  \begin{split}
  \begin{bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j & j_{23}
  \end{bmatrix}\delta_{jj^\prime}
  &=\sum_{m_i,m_{ik}}\\
  &C^{j_1,j_2\rightarrow j_{12}}_{m_1,m_2\rightarrow m_{12}}
  C^{j_2,j_3\rightarrow j_{23}}_{m_2,m_3\rightarrow m_{23}}\\
  &C^{j_1,j_{23}\rightarrow j^\prime}_{m_1,m_{23}\rightarrow m^\prime}
  C^{j_{12}j_3\rightarrow j}_{m_{12}m_3\rightarrow m}
  \end{split}
\end{equation}
In the first column the CGC share the first irrep and in the second column they share the second irrep.
The second and third irrep from the CGC in the first column and first row build the first irrep from the CGC
in the second column.
The second and thir irreps from the CGC from the first column and second row build the third irreps
of the CGC in the second column.
It is worthwhile to have this visual structure to identify if the sum over four CGC forms a recoupling coeff or not.
The $[\dots]$-symbol is the recoupling coeff which is related to the $6j$-symbol (curly brackets):
\begin{equation}
  \label{eq:recoupl-6j}
    \begin{Bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j & j_{23}
  \end{Bmatrix}
  = (-1)^{j_1+j_2+j_3+j}\frac{1}{\sqrt{(2j_{12}+1)(2j_{23}+1)}}
  \begin{bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j & j_{23}
  \end{bmatrix}
\end{equation}
The same quantities exist for four irreps. The recoupling coeff is:
\begin{equation}
  \label{eq:recoupling-four}
  \begin{split}
  \begin{bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j_4 & j_{34} \\
    j_{13} & j_{24} &j
  \end{bmatrix}
    =
   &\sum_{m_i,m_{ik}}\\
   &C^{j_1,j_2\rightarrow j_{12}}_{m_1,m_2\rightarrow m_{12}}C^{j_3,j_4\rightarrow j_{34}}_{m_3,m_4\rightarrow m_{34}}C^{j_{12},j_{34}\rightarrow j}_{m_{12},m_{34}\rightarrow m}\\
   &C^{j_1,j_3\rightarrow j_{13}}_{m_1,m_3\rightarrow m_{13}}C^{j_2,j_4\rightarrow j_{24}}_{m_2,m_4\rightarrow m_{24}}C^{j_{13},j_{24}\rightarrow j}_{m_{13},m_{24}\rightarrow m}
   \end{split}
\end{equation}
Notice, that: in the first column the CGC shares the first irrep, in the second column they share the second irrep
and in the third column they share the third irrep. Between the first and second column
one can draw a cross from $j_2<-->j_2$ and $j_3<-->j_3$. In the last column the first and second irrep
of each CGC comes from the third irrep in the CGC in the same row but from the first or second column respectively.
All $m$ are summed beside the last one from the CGC in the third column.
It is worthwhile to have this visual structure to identify if the sum over six CGC forms a recoupling coeff or not.
The $9j$-symbol is defined as:
\begin{equation}
  \label{eq:sym-9jsymbol}
  \begin{Bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j_4 & j_{34} \\
    j_{13} & j_{24} &j
  \end{Bmatrix}
   =
  \frac{1}{\sqrt{(2j_{12}+1)(2j_{34}+1)(2j_{13}+1)(2j_{24}+1)}}
  \begin{bmatrix}
    j_1 & j_2 & j_{12} \\
    j_3 & j_4 & j_{34} \\
    j_{13} & j_{24} &j
  \end{bmatrix}
\end{equation}
\section{Wigner-Eckart}
For a tensor operator $O^{[k]}_m$ the following holds:
\begin{equation}
  \label{eq:wigner-eckart-def}
\Braket{j_1,m_1|O^{[k]}_m|j_2,m_2} = C^{j_2k\rightarrow j_1}_{m_2m\rightarrow m_1}\Braket{j_1||O^{[k]}||j_2}
\end{equation}
This is convention also used by Mc Culloch. The CGC is build so that the first irrep is the ket, the second irrep is the operator irrep
and the total irrep is the bra. For $U(1)$ this means $ket+op=bra$.

For an operator with $k=0$ (scalar operator), the CGC part is $\delta_{j_2j_1}\delta_{m_2m_1}$,
so that the reduced matrix elements are the same as the normal matrix elements.
If the trace however is calculated from the reduced matrix elements,
one needs to take into account
that $2j_1+1$ copies of the reduced matrix elements appear:
\begin{equation}
  \text{tr}O=\sum_j(2j+1)\Braket{j||O^{[0]}||j}
\end{equation}
This coefficients is called \textsc{coeff\_dot} in the implementation.
It appears at every situation, where one obtains a scalar quantity.
E.g. when contracting the left and right environment to obtain an expectation value.
\subsection{Product of tensor operators}
The product of two operators $O^{[k_1]}_{m_1}$ and $S^{[k_2]}_{m_2}$
gives rise to different irreducible tensor operators by the definition:
\begin{equation}
  \label{eq:tensor-prod}
  \left[O^{[k_1]}\times S^{[k_2]}\right]^{[k]}_m = \sum_{m_1,m_2} C^{k_1k_2\rightarrow k}_{m_1m_2\rightarrow m} O^{[k_1]}_{m_1}S^{[k_2]}_{m_2}
\end{equation}
One can obtain the reduced matrix elements of the product directly from the reduced matrix elements
of the individual operators. To see this, one inserts in Eq. \eqref{eq:tensor-prod}
the CGC as defined in the Wigner-Eckart theorem for all operators, namely $O^{[k_1]}_{m_1}$,  $S^{[k_2]}_{m_2}$
and $\left[O^{[k_1]}\times S^{[k_2]}\right]^{[k]}_m$. Therefore, one sandwiches the equation with
$\Braket{j_1,m_{j_1}|\dots|j_2m_{j_2}}$ and introduces an identity $\sum_{j_3m_{j_3}}\Ket{j_3m_{j_3}}\Bra{j_3m_{j_3}}$
for the operator product on the right side of Eq. \eqref{eq:tensor-prod}.
For clearness it is worthwile to omit the reduced matrix elements because they factor out.
The CGC part reads then:
\begin{equation}
  C^{j_2k\rightarrow j_1}_{m_{j_2}m_k\rightarrow m_{j_1}}  =
  \sum_{m_{k_1},m_{k_2},m_{j_3}}
  C^{k_1k_2\rightarrow k}_{m_{k_1}m_{k_2}\rightarrow m_{k}}
  C^{j_3k_1\rightarrow j_1}_{m_{j_3}m_{k_1}\rightarrow m_{j_1}}
  C^{j_2k_2\rightarrow j_3}_{m_{j_2}m_{k_1}\rightarrow m_{j_3}}
\end{equation}
The CGC at the left side can be brought to the right side by multiplying
with $C^{j_2k\rightarrow J_1}_{m_{j_2}m_k\rightarrow m_{J_1}}$ and summing over $m_{j_2}$ and $m_k$.
This gives $\delta_{j_1J_1}\delta_{m_{j_1}m_{J_1}}$ for the left side and for right side:
\begin{equation}
  \begin{split}
    \delta_{j_1J_1}\delta_{m_{j_1}m_{J_1}}  &=
    \sum_{m_{k_1},m_{k_2},m_{j_3},m_{j_2},m_k}\\
    &C^{j_2k_2\rightarrow j_3}_{m_{j_2}m_{k_1}\rightarrow m_{j_3}}
    C^{k_1k_2\rightarrow k}_{m_{k_1}m_{k_2}\rightarrow m_{k}}\\
    &C^{j_2k\rightarrow j_1}_{m_{j_2}m_k\rightarrow m_{j_1}}
    C^{j_3k_1\rightarrow j_1}_{m_{j_3}m_{k_2}\rightarrow m_{j_1}}
  \end{split}
\end{equation}
This equation does not fit the definition of the recouple coeff in Eq. \eqref{eq:recoupling-three}.
To reach this, one has to interchange $k_1$ and $k_2$ in the CGC $C^{k_1k_2\rightarrow k}_{m_{k_1}m_{k_2}\rightarrow m_{k}}$.
This leads to a an additional phase factor $(-1)^{k_1+k_2-k}$.
Afterwards, one can perform the sum over the $m$ quantum numbers to obtain a recouple coeff as in Eq. \eqref{eq:recoupling-three}.
\begin{equation}
  \begin{split}
  \delta_{j_1J_1}\delta_{m_{j_1}m_{J_1}}  &=
  (-1)^{k_1+k_2-k}
  \begin{bmatrix}
    j_2 & k_1 & j_{3} \\
    k_2 & j_1 & k
  \end{bmatrix}\delta_{j_1J_1}\delta_{m_{j_1}m_{J_1}}\\
  &=
  (-1)^{k_1+k_2-k}(-1)^{j_2+k_1+k_2+j_1}\sqrt{(2j_3+1)(2k+1)}
  \begin{Bmatrix}
    j_2 & k_1 & j_{3} \\
    k_2 & j_1 & k
  \end{Bmatrix}\delta_{j_1J_1}\delta_{m_{j_1}m_{J_1}}
  \end{split}
\end{equation}
For the sign, one finds:
\begin{equation}
  (-1)^{k_1+k_2-k-k+k+j_2+k_1+k_2+j_1}=(-1)^{2(k_1+k_2-k)}(-1)^{k+j_2+j_1}=(-1)^{k+j_2+j_1},
\end{equation}
because $k_1$, $k_2$ and $k$ fulfil the triangle condition.
In summary, the coefficient for the product is:
\begin{equation}
  \label{eq:coeff_prod}
  \begin{split}
  \Braket{j_1 ||\left[O^{[k_1]}\times S^{[k_2]}\right]^{[k]}_m||j_2} =& \sum_{j_3}(-1)^{k+j_2+j_1}\sqrt{(2j_3+1)(2k+1)}
  \begin{Bmatrix}
    j_2 & k_1 & j_{3} \\
    k_2 & j_1 & k
  \end{Bmatrix}\\
  &\Braket{j_1||O^{[k_1]}||j_3}\Braket{j_3||S^{[k_2]}||j_2}
  \end{split}
\end{equation}
The corresponding coefficient is called \textsc{coeff\_prod}.
\subsection{Adjoint of tensor operators}
The adjoint of tensor operators can be defined with respect to the metric defined in
Eq. \eqref{eq:tensor-prod} when coupling two operators of rank $k$ to
a singlet operator ($k=0$). The corresponding CGC is
$C^{kk\rightarrow 0}_{m_1m_2\rightarrow 0}=\frac{(-1)^{k-m_1}}{\sqrt{2k+1}}\delta_{m_1,-m_2}$.
The adjoint tensor operator is therefore:
\begin{equation}
  \label{eq:def-adjoint}
  O^{\dagger [k]}_m = (-1)^{k-m}\left(O^{[k]}_{-m}\right)^\dagger
\end{equation}
The Wigner Eckart theorem gives:
\begin{equation}
  \Braket{j_1m_1|O^{\dagger [k]}_m|j_2m_2}=C^{j_2k\rightarrow j_1}_{m_2m\rightarrow m_1}\Braket{j_1||O^{\dagger[k]}||j_2}
\end{equation}
The reduced matrix elements of the adjoint are related to the original one.
The factor is obtained when applying the Wigner Eckart theorem for Eq. \eqref{eq:def-adjoint}:
\begin{equation}
  C^{j_2k\rightarrow j_1}_{m_2m\rightarrow m_1} = (-1)^{k-m} C^{j_1k\rightarrow j_2}_{m_1,-m\rightarrow m_2}
\end{equation}
Interchanging $j_1$ and $j_2$ at the right side leads to the factor $\sqrt{\frac{2j_2+1}{2j_1+1}}(-1)^{k-m}$
and to the subtitution $m_1$ to $-m_1$ and $m_2$ to $-m_2$ in the CGC at the right.
The sign $(-1)^{k-m}$ cancels and after reverting all signs of the CGC at the right, the two
CGC are identical. Reverting all signs give another sign $(-1)^{j_1+k-j_2}$ so that the corresponding coeff reads:
\begin{equation}
  \Braket{j_1||O^{\dagger[k]}||j_2} = (-1)^{j_1+k-j_2}\sqrt{\frac{2j_2+1}{2j_1+1}}(-1)^{k-m}\Braket{j_2||O^{[k]}||j_1}^*
\end{equation}
The corresponding coefficient is called \textsc{coeff\_adjoint} in the implementation.
Notice that $O^{\dagger^\dagger[k]}=(-1)^{2k}O^{[k]}$.
\subsection{Spin operator}

\subsection{Fermionic operators}
\section{Convention for MPS, MPO and environments}
For an MPS, we choose the following convention for the CGC:
\begin{equation}
  \label{eq:mps-def}
  A^\sigma_{ij} = A^\sigma_{ij}C^{i\sigma\rightarrow j}_{m_im_\sigma\rightarrow m_j}
\end{equation}
This is different from the convention by Mc Culloch. For $U(1)$ it corresponds to $i+\sigma=j$.
$i$ is the left index from $A$ and $j$ the right index.

For an MPO, we choose the following convention for the CGC:
\begin{equation}
  \label{eq:mpo-def}
  W^{[k]\sigma_1\sigma_2}_{ab} = W^{[k]\sigma_1\sigma_2}_{ab}C^{\sigma_2k\rightarrow \sigma_1}_{m_{\sigma_2}m_k\rightarrow m_{\sigma_1}}
  C^{ak\rightarrow b}_{m_am_k\rightarrow m_b}
\end{equation}
For $U(1)$ it corresponds to $a+b=j$ and $\sigma_2+k=\sigma_1$.
$a$ is the left index from $W$ and $b$ the right index.
$\sigma_2$ points in the direction of the ket MPS while $\sigma_1$ into the direction of the bra.

For the left environment we have:
\begin{equation}
  \label{eq:left-def}
  L^a_{ij} = L^a_{ij}C^{ia\rightarrow j}_{m_im_a\rightarrow m_j}
\end{equation}
For $U(1)$ it corresponds to $i+a=j$. $i$ is pointing to the ket layer, $j$
is pointing to the bra layer.

For the right environment we have:
\begin{equation}
  \label{eq:right-def}
  R^a_{ij} = R^a_{ij}C^{ia\rightarrow j}_{m_im_a\rightarrow m_j}
\end{equation}
For $U(1)$ it corresponds to $i+a=j$. $i$ is pointing to the ket layer, $j$
is pointing to the bra layer.

\section{Algorithms}
\subsection{Sweep and reshape}]
Reshaping is is the combination of two indices into a super index.
This is essentially an isometry which maps the basis states from the
two indices into one. The reshaping process is not unique and a convention is neccesary.
E.g. without any symmetries a isometry $\Pi_{i\sigma}^k$ could be chosen as
$\Pi_{i\sigma}^k=1$ if $k=i+\text{dim}(i)\sigma$ and $\Pi_{i\sigma}^k=0$ otherwise.
For symmetric tensors, the isometry should map on proper irreps of the syymetry.
The combination of two irreps into the tensor product is exactly the definition
for the CGC, so that the isometry $\Pi$ needs to be proportional to the CGC.

For a right sweep, we want to left-normalize the $A$-tensor.
Hence the incoming index $i$ get combined with the physical index $\sigma$.
The symmetry part of isometry $\Pi$ is chosen as $\Pi=C^{i\sigma\rightarrow k}_{m_im_\sigma\rightarrow m_k}$.
We have $\Pi\cdot\Pi^\dagger=1$ since:
\begin{equation}
  \sum_{m_im_\sigma}C^{i\sigma\rightarrow k}_{m_im_\sigma\rightarrow m_k}C^{i\sigma\rightarrow k}_{m_im_\sigma\rightarrow m_k}=1
\end{equation}
is a orthonormality condition for the CGC.
Furthermore in the calculation $\Pi\cdot A$, the CGC drop out for the same reason.
Hence there is no extra factor for a right sweep step (left-normalization step).
\begin{equation}
  A^\sigma_{ij} = \tilde{A}^{(i\sigma)}_j
\end{equation}
There is also no extra factor when checking for the left-nomalize condition.

For a left sweep, we want to right-normalize the $A$-tensor.
Hence the outgoing index $j$ get combined with the physical index $\sigma$.
The symmetry part of isometry $\Pi$ is chosen as $\Pi\sim C^{k\sigma\rightarrow j}_{m_km_\sigma\rightarrow m_j}$.
We have $\Pi\cdot\Pi^\dagger\neq1$ but:
\begin{equation}
  \label{eq:right-ortho}
  \sum_{m_jm_\sigma}C^{k\sigma\rightarrow j}_{m_km_\sigma\rightarrow m_j}C^{k\sigma\rightarrow j}_{m_km_\sigma\rightarrow m_j}=\frac{2j+1}{2k+1}
\end{equation}
This can be seen when changing the indices $k$ and $j$ in both CGC which leads to the factor $\sqrt{\frac{2j+1}{2k+1}}(-1)^{\sigma-m_\sigma}$.
The phase factor drops out because it appears twice. The CGC after the interchange multiply to one.
A proper normalized $\Pi$ is in fact an isometry: $\Pi=\sqrt{\frac{2k+1}{2j+1}}C^{k\sigma\rightarrow j}_{m_km_\sigma\rightarrow m_j}$.
When calculating $\Pi\cdot A$, one encounters the same equation as above so there is a factor for the left sweep:
\begin{equation}
  A^\sigma_{ij} = \sqrt{\frac{2j+1}{2i+1}}\tilde{A}^{(\sigma j)}_i
\end{equation}
This factor is called \textsc{coeff\_leftSweep} in the implementation.
Notice that for the inverse reshaping process, one needs the inverse of this factor.
This factor has no different name but simply \textsc{coeff\_leftSweep} is called with reversed quantum numbers.
When checking for the right-normalize condition one encounters also Eq. \eqref{eq:right-ortho}.
Hence one has to encounter the factor from the CGC when checking the right-normalize condition:
\begin{equation}
  \sum_{\sigma j}A^\sigma_{ij}A^{\dagger\sigma}_{ij}\frac{2j+1}{2i+1} 
\end{equation}
This factor is called \textsc{coeff\_rightOrtho} in the implementation.
\subsection{Update $L$}
For updating the left environment, we have the following equation:
\begin{equation}
  \pmb{L}_{b_l}(l+1) = \sum_{\sigma_{l},\sigma_{l}^\prime,a_l}\pmb{B}^{\sigma_{l}\dagger}(l)\pmb{L}_{a_{l}}(l)\pmb{A}^{\sigma_{l}^\prime}(l)W^{\sigma_{l}\sigma_{l}^\prime}_{a_{l}b_l}(l)
\end{equation}
Inserting all the CGC for the tensors, the CGC part of this equation reads:
\begin{equation}
  C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}} =
  \sum_{m_{\sigma_1},m_{\sigma_2},m_i,m_a,m_j,m_k}
  C^{ j,\sigma_1\rightarrow j^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{j^\prime}}
  C^{i a\rightarrow j}_{m_{i},m_{a} \rightarrow m_{j}}
  C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
\end{equation}
We can multiply this equation with $C^{i^\prime a^\prime\rightarrow J^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{J^\prime}}$
and sum over $m_{i^\prime}$ and $m_{a^\prime}$. The left hand side is then $\delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}}$
and the right side becomes:
\begin{equation}
  \begin{split}
  \delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}} &=
  \sum_{m_{\sigma_1},m_{\sigma_2},m_i,m_a,m_j,m_k,m_{i^\prime},m_{a^\prime}}\\
  &C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
  C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}}\\
  &C^{i a\rightarrow j}_{m_{i},m_{a} \rightarrow m_{j}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}
  C^{ j,\sigma_1\rightarrow J^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{J^\prime}}\\
  &=
  \begin{bmatrix}
    i & \sigma_2 & i^\prime \\
    a & k & a^\prime \\
    j & \sigma_1 &j^\prime
  \end{bmatrix}\delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}}
  \end{split}
\end{equation}
Which is easily obtained when analysing that the visual structure fits the requirements for the recoupling coeff in Eq. \eqref{eq:recoupling-four}.
This coeffecient is called \textsc{coeff\_buildL}.
\subsection{Update $R$}
The update of the right environment is similar.
Collecting all the CGC for the tensors, the CGC part reads:
\begin{equation}
  C^{i a\rightarrow j}_{m_{i},m_{a} \rightarrow m_{j}} =
  \sum_{m_{\sigma_1},m_{\sigma_2},m_j,m_k,m_{i^\prime},m_{a^\prime}}
  C^{ j,\sigma_1\rightarrow j^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{j^\prime}}
  C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}}
  C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
\end{equation}
We can multiply this equation with $C^{i a\rightarrow J}_{m_{i},m_{a} \rightarrow m_{J}}$
and sum over $m_{i}$ and $m_{a}$. The left hand side is then $\delta_{jJ}\delta_{m_{j}m_{J}}$
and the right side becomes:
\begin{equation}
  \begin{split}
  \delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}} &=
  \sum_{m_{\sigma_1},m_{\sigma_2},m_i,m_a,m_j,m_k,m_{i^\prime},m_{a^\prime}}\\
  &C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
  C^{i a\rightarrow J}_{m_{i},m_{a} \rightarrow m_{J}}\\
  &C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}
  C^{ j,\sigma_1\rightarrow j^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{j^\prime}}
  \end{split}
\end{equation}
This is not the correct structure for a recoupling coeff.
But the following steps will convert this into the form of Eq. \eqref{eq:recoupling-four}.
Notice, that I will use \emph{coordinates} $(i,j)$ to refer to the CGC in this equation
where $i$ is the row and $j$ is the column.
\begin{enumerate}
\item
  interchange $i$ and $i^\prime$ for $(0,0)$. This gives a factor
  $(-1)^{\sigma_2+m_{\sigma_2}}\sqrt{\frac{2i^\prime+1}{2i+1}}$.
  Furthermore $m_{i}$ and $m_{i^\prime}$  goes into $-m_{i}$ and $-m_{i^\prime}$.
\item
  interchange $j$ and $j^\prime$ for $(1,2)$. This gives a factor
  $(-1)^{\sigma_1+m_{\sigma_1}}\sqrt{\frac{2j^\prime+1}{2j+1}}$.
  Furthermore $m_{j}$ and $m_{j^\prime}$  goes into $-m_{j}$ and $-m_{j^\prime}$.
\item
  interchange $a$ and $a^\prime$ for $(0,1)$. This gives a factor
  $(-1)^{k+m_{k}}\sqrt{\frac{2a^\prime+1}{2a+1}}$.
  Furthermore $m_{a}$ and $m_{a^\prime}$  goes into $-m_{a}$ and $-m_{a^\prime}$.
\item
  Flip all signs of the $m$ quantum numbers for the CGC in $(0,0)$, $(1,1)$, $(1,2)$ and $(0,1)$.
  This gives four phase factors: $(-1)^{i^\prime+\sigma_2-i}$, $(-1)^{\sigma_2+k-\sigma_1}$, $(-1)^{j^\prime+\sigma_1-j}$ and $(-1)^{a^\prime+k-a}$.
\item
  The signs $(-1)^{\sigma_2+m_{\sigma_2}}$, $(-1)^{\sigma_1+m_{\sigma_1}}$, $(-1)^{k+m_{k}}$ and $(-1)^{\sigma_2+k-\sigma_1}$
  gives in total $+1$. This can be seen when noting that $m_{\sigma_1}=m_{\sigma_2}+m_k$ (because of the corresponding CGC) and $(-1)^{2(j+m_j)}=1$
  for any $j$ and $m_j$ which belong together.
\item
  All $m$-dependent factors disappear and the sum over the resulting CGC give a recoupling coeff:
  \begin{equation}
    \begin{bmatrix}
      i^\prime & \sigma_2 & i \\
      a^\prime & k & a \\
      j^\prime & \sigma_1 &j
  \end{bmatrix}
\end{equation}
together with the factor:
\begin{equation}
  (-1)^{i^\prime+\sigma_2-i}(-1)^{j^\prime+\sigma_1-j}(-1)^{a^\prime+k-a}\sqrt{\frac{(2i^\prime+1)(2j^\prime+1)(2a^\prime+1)}{(2i+1)(2j+1)(2a+1)}}
\end{equation}
\item
  Convert the recoupling coeff to a $9j$-symbol by Eq. \eqref{eq:sym-9jsymbol}.
  Interchange the first and the last column of the $9j$-symbol. This gives a phase factor given by the sum af all
  quantum numbers in the $9j$-symbol. Converting back to a recoupl coeff giv the final coefficient used for
  the update of the right environment:
  \begin{equation}
    \frac{2j^\prime+1}{2j+1}
    \begin{bmatrix}
      i & \sigma_2 & i^\prime \\
      a & k & a^\prime \\
      j & \sigma_1 &j^\prime
    \end{bmatrix}
  \end{equation}
  This coefficient is called \textsc{coeff\_buildR} in the implementation.
\end{enumerate}
\subsection{Apply $H_{eff}$}
For the effective Hamiltonian the CGC part reads:
\begin{equation}
  C^{ j,\sigma_1\rightarrow j^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{j^\prime}} =
  \sum_{m_{\sigma_1},m_{\sigma_2},m_i,m_a,m_j,m_k}
  C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}}
  C^{i a\rightarrow j}_{m_{i},m_{a} \rightarrow m_{j}}
  C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
\end{equation}
We can multiply this equation with $C^{ j,\sigma_1\rightarrow J^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{J^\prime}}$
and sum over $m_{j}$ and $m_{\sigma_1}$. The left hand side is then $\delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}}$
and the right side becomes:
\begin{equation}
  \begin{split}
  \delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}} &=
  \sum_{m_{\sigma_1},m_{\sigma_2},m_i,m_a,m_j,m_k,m_{i^\prime},m_{a^\prime}}\\
  &C^{i,\sigma_2\rightarrow i^\prime}_{m_i,m_{\sigma_2}\rightarrow m_{i^\prime}}
  C^{a,k\rightarrow a^\prime}_{m_a,m_k\rightarrow m_{a^\prime}}
  C^{i^\prime a^\prime\rightarrow j^\prime}_{m_{i^\prime},m_{a^\prime} \rightarrow m_{j^\prime}}\\
  &C^{i a\rightarrow j}_{m_{i},m_{a} \rightarrow m_{j}}
  C^{\sigma_2,k\rightarrow\sigma_1}_{m_{\sigma_2},m_k\rightarrow m_{\sigma_1}}
  C^{ j,\sigma_1\rightarrow J^\prime}_{ m_j,m_{\sigma_1}\rightarrow m_{J^\prime}}\\
  &=
  \begin{bmatrix}
    i & \sigma_2 & i^\prime \\
    a & k & a^\prime \\
    j & \sigma_1 &j^\prime
  \end{bmatrix}\delta_{j^\prime J^\prime}\delta_{m_{j^\prime} m_{J^\prime}}
  \end{split}
\end{equation}
Which is easily obtained when analysing that the visual structure fits the requirements for the recoupling coeff in Eq. \eqref{eq:recoupling-four}.
This coeffecient is called \textsc{coeff\_HPsi}. It is identical to \textsc{coeff\_buildL}.
\subsection{MPS product}
The product of two MPS is obtained by the product over the auxiliary space and the combination
of $\sigma_1$ and $\sigma_2$ to a combined index $\sigma$.
The CGC part of this operation reads:
\begin{equation}
  C^{i,\sigma\rightarrow j}_{m_i,m_{\sigma}\rightarrow m_{j}}=
  \sum_{m_{\sigma_1},m_{\sigma_2},m_{i^\prime}}
  C^{i,\sigma_1\rightarrow i^\prime}_{m_i,m_{\sigma_1}\rightarrow m_{i^\prime}}
  C^{i^\prime,\sigma_2\rightarrow j}_{m_{i^\prime},m_{\sigma_2}\rightarrow m_{j}}
  C^{\sigma_1\sigma_2\rightarrow\sigma}_{m_{\sigma_1}m_{\sigma_2}\rightarrow m_{\sigma}}
\end{equation}
Again we bring the CGC from the left side to the right side by using a orthonormality equation for the CGC
and obtain:
\begin{equation}
  \begin{split}
    \delta_{jJ}\delta_{m_jm_J}&=
    \sum_{m_{\sigma_1},m_{\sigma_2},m_{i^\prime},m_i,m_{\sigma}}\\
    &C^{i,\sigma_1\rightarrow i^\prime}_{m_i,m_{\sigma_1}\rightarrow m_{i^\prime}}
    C^{i^\prime,\sigma_2\rightarrow j}_{m_{i^\prime},m_{\sigma_2}\rightarrow m_{j}}\\
    &C^{i,\sigma\rightarrow J}_{m_i,m_{\sigma}\rightarrow m_{J}}
    C^{\sigma_1\sigma_2\rightarrow\sigma}_{m_{\sigma_1}m_{\sigma_2}\rightarrow m_{\sigma}}\\
    &=
    \begin{bmatrix}
      i & \sigma_1 & i^\prime \\
      \sigma_2 & j & \sigma
    \end{bmatrix}\delta_{jJ}\delta_{m_jm_J}
  \end{split}
\end{equation}
The recoupl coeff is related to the $6j$-symbol and this coefficient
for the product of two $A$-tensors is called \textsc{coeff\_Apair}
in the implementation. Notice, that this is different to \textsc{coeff\_prod} (Eq. \eqref{eq:coeff_prod}).
This is because of our convention for the $A$-tensors.
\subsection{MPO product}
The product of two MPOs can be done in auxiliary space or in the
physical space. For the product in the physical space, the CGC
structure is as follows\footnote{$k_{23}$ is the operator which acts
  first on the ket, afterwards $k_{12}$ is applied.}:
\begin{equation}
  \begin{split}
  \sum_{m_K}C^{A,K\rightarrow A^\prime}_{m_A,m_{K}\rightarrow
    m_{A^\prime}}C^{\sigma_3,K\rightarrow
    \sigma_1}_{m_{\sigma_3},m_{K}\rightarrow m_{\sigma_1}}&=\\
  &\sum_{m_{a},m_{b},m_{a^\prime},m_{b^\prime}} C^{a,b\rightarrow A}_{{m_a,m_{b}}\rightarrow m_{A}}C^{a^\prime,b^\prime\rightarrow A^\prime}_{m_{a^\prime},m_{b^\prime}\rightarrow m_{A^\prime}}\\
  &\sum_{m_{k_{12}}}C^{a,k_{12}\rightarrow
    a^\prime}_{m_a,m_{k_{12}}\rightarrow
    m_{a^\prime}}C^{\sigma_2,k_{12}\rightarrow
    \sigma_1}_{m_{\sigma_2},m_{k_{12}}\rightarrow m_{\sigma_1}}\\
  &\sum_{m_{k_{23}}}C^{b,k_{23}\rightarrow b^\prime}_{m_b,m_{k_{23}}\rightarrow m_{b^\prime}}C^{\sigma_3,k_{23}\rightarrow \sigma_2}_{m_{\sigma_3},m_{k_{23}}\rightarrow m_{\sigma_2}}
  \end{split}
\end{equation}
One can invert the left side of this equation by multiplying with two
contracted CGCs with fixed $\tilde{K}$:
\begin{equation}
  \sum_{m_K}\sum_{m_{A},m_{A^\prime},m_{\sigma_3},m_{\sigma_1}}C^{A,\tilde{K}\rightarrow
    A^\prime}_{m_A,m_{\tilde{K}}\rightarrow m_{A^\prime}}C^{\sigma_3,\tilde{K}\rightarrow\sigma_1}_{m_{\sigma_3},m_{\tilde{K}}\rightarrow
    m_{\sigma_1}}
  C^{A,K\rightarrow
    A^\prime}_{m_A,m_{K}\rightarrow m_{A^\prime}}C^{\sigma_3,K\rightarrow\sigma_1}_{m_{\sigma_3},m_{K}\rightarrow
    m_{\sigma_1}}  
\end{equation}
Now, one can bring $K$ and $\tilde{K}$ at the third position of the
CGCs. This gives the factor $\sqrt{\frac{2X+1}{2K+1}}$ and switches
the sign of the $m$ quantum number of the second and third position.
The resulting contraction is proportional to
$\delta_{K,\tilde{K}}\delta_{m_K,m_{\tilde{K}}}$ with a constant
factor $\frac{(2A^\prime+1)(2\sigma_1+1)}{(2K+1)^2}$.
Inverting the factor and doing the same multiplication of CGCs on the
right side, one arrives at:
\begin{equation}
  \begin{split}
  \delta_{K,\tilde{K}}\delta_{m_K,m_{\tilde{K}}}&=
  \frac{(2K+1)^2}{(2A^\prime+1)(2\sigma_1+1)}\\
  &\sum_{m_{A},m_{A^\prime},m_{\sigma_3},m_{\sigma_1}}C^{A,K\rightarrow
    A^\prime}_{m_A,m_{K}\rightarrow m_{A^\prime}}C^{\sigma_3,K\rightarrow\sigma_1}_{m_{\sigma_3},m_{K}\rightarrow
    m_{\sigma_1}}\\
  &\sum_{m_{a},m_{b},m_{a^\prime},m_{b^\prime}} C^{a,b\rightarrow A}_{{m_a,m_{b}}\rightarrow m_{A}}C^{a^\prime,b^\prime\rightarrow A^\prime}_{m_{a^\prime},m_{b^\prime}\rightarrow m_{A^\prime}}\\
  &\sum_{m_{k_{12}}}C^{a,k_{12}\rightarrow
    a^\prime}_{m_a,m_{k_{12}}\rightarrow
    m_{a^\prime}}C^{\sigma_2,k_{12}\rightarrow
    \sigma_1}_{m_{\sigma_2},m_{k_{12}}\rightarrow m_{\sigma_1}}\\
  &\sum_{m_{k_{23}}}C^{b,k_{23}\rightarrow b^\prime}_{m_b,m_{k_{23}}\rightarrow m_{b^\prime}}C^{\sigma_3,k_{23}\rightarrow \sigma_2}_{m_{\sigma_3},m_{k_{23}}\rightarrow m_{\sigma_2}}
  \end{split}
\end{equation}
One is left with a contraction of eight CGCs which gives a $12-j$
symbol. Fortunately, the $12j$ symbol decomposes in this case in a
product of a $9j$ symbol and a $6j$ symbol. The decomposition can be
achieved by multiplying with
\begin{equation}
1=\sum_{m_{k_{12}^\prime},m_{k_{23}^\prime}}\sum_{Q,m_{Q}}C^{k_{12},k_{23}\rightarrow Q}_{m_{k_{12}},m_{k_{23}}\rightarrow m_{Q}}C^{k_{12},k_{23}\rightarrow Q}_{m_{k_{12}^\prime},m_{m_{k_{12}^\prime}}\rightarrow m_{Q}}
\end{equation}
After properly sorting the 10 CGCs  one arrives at \footnote{Note the sum over
$Q$ is dropped. It is an outersum over a $j$ quantum number (not an
$m$ quantum number but of course one has to keep it in mind)}:
\begin{equation}
  \begin{split}
  \delta_{K,\tilde{K}}\delta_{m_K,m_{\tilde{K}}}&=
  \frac{(2K+1)^2}{(2A^\prime+1)(2\sigma_1+1)}\sum_{m_Q}\\
  &\sum_{m_{A},m_{A^\prime},m_{a},m_{a^\prime},m_{b},m_{b^\prime},m_{k_{12}},m_{k_{23}}}\\
  &C^{A,K\rightarrow
    A^\prime}_{m_A,m_{K}\rightarrow
    m_{A^\prime}}C^{k_{12},k_{23}\rightarrow
    Q}_{m_{k_{12}},m_{k_{23}}\rightarrow m_{Q}}\\
  &C^{a,k_{12}\rightarrow
    a^\prime}_{m_a,m_{k_{12}}\rightarrow m_{a^\prime}}C^{b,k_{23}\rightarrow b^\prime}_{m_b,m_{k_{23}}\rightarrow m_{b^\prime}}\\
  & C^{a,b\rightarrow
    A}_{{m_a,m_{b}}\rightarrow m_{A}}C^{a^\prime,b^\prime\rightarrow
    A^\prime}_{m_{a^\prime},m_{b^\prime}\rightarrow
    m_{A^\prime}}\\
   &\sum_{m_{\sigma_1},m_{\sigma_2},m_{\sigma_3},m_{k_{12}^\prime},m_{k_{23}^\prime}}\\
   &C^{\sigma_3,K\rightarrow\sigma_1}_{m_{\sigma_3},m_{K}\rightarrow
    m_{\sigma_1}}C^{k_{12},k_{23}\rightarrow Q}_{m_{k_{12}^\prime},m_{m_{k_{12}^\prime}}\rightarrow m_{Q}}\\
  &C^{\sigma_2,k_{12}\rightarrow
    \sigma_1}_{m_{\sigma_2},m_{k_{12}^\prime}\rightarrow m_{\sigma_1}}C^{\sigma_3,k_{23}\rightarrow \sigma_2}_{m_{\sigma_3},k_{23}^\prime\rightarrow m_{\sigma_2}}
  \end{split}
\end{equation}
The first six CGC are proportional to a $9j$ box symbol (Eq. \ref{eq:recoupling-four}). The factor is
$\frac{2A^\prime+1}{2K+1}$.
The last four CGC are proportional to a $6j$ box symbol
(Eq. \ref{eq:recoupling-three}). The factor is
$\frac{2\sigma_1+1}{2K+1}$. This kills the factor in front of the 10
CGCs so that the final result reads:
\begin{equation}
    \delta_{K,\tilde{K}}\delta_{m_K,m_{\tilde{K}}}=
    \begin{bmatrix}
    \sigma_3 & k_{23} & \sigma_2 \\
    k_{12} & \sigma_3 & K
  \end{bmatrix}
  \begin{bmatrix}
    a & b & A \\
    k_{12} & k_{23} & K \\
    a^\prime & b^\prime &A^\prime
  \end{bmatrix}
\end{equation}
The first coefficient is called \textsc{coeff\_MPOprod6}, the second
is called \textsc{coeff\_MPOprod9}.
\subsection{MPO times MPS}
For this operation, the structure is completely identical to the action of the effective Hamiltonian.
This is due to our definition of the CGC structure of the environment.
The coefficient is therefore identical to \textsc{coeff\_HPsi}.
In the implementation, it has an extra name: \textsc{coeff\_AW}.
\section{Todo}
\begin{enumerate}
\item Add graphical visualizations of the different contractions.
\item Describe the local operators and their reduced matrix elements.
\item Describe the tensor product of tensor operators for the coefficient \textsc{coeff\_tensorProd}.
\item Think about recoupling of five irreps and $12j$-symbols. What is problem here?
\end{enumerate}
\end{document}
%%% Local Variables:
%%% mode: latex
%%% TeX-master: t
%%% End:
